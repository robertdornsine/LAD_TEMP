experiment_name: "Abilene_12x12_qwen_diffusion_4060_simpleCNN"

# ===== 数据配置
data:
  data_dir: 'D:\PyCharm\traffic_prediction_trial\Abilene_dataset_related\od_grayscale_images_Abilene_sampled'
  history_len: 16
  image_size: 12
  normalize: true
  train_ratio: 0.7
  val_ratio: 0.15
  test_ratio: 0.15

augmentation:
  enabled: true
  random_noise: 0.02
  random_scale: 0.1
  mixup_alpha: 0.5
  mixup_prob: 0.7


  #augmentation:
   # random_noise: 0.01
    #random_scale: 0.05
    #random_shift: 1

# ===== 训练配置 =====
training:
  # 批次大小
  batch_size: 8                          # 单GPU实际batch size
  gradient_accumulation_steps: 4         # 梯度累积步数
  # 等效batch_size = 8 * 4 = 32

  # 训练周期
  num_epochs: 300

  # 学习率
  learning_rate: 3.0e-5
  lr_scheduler: "cosine"
  warmup_epochs: 15
  min_lr: 1.0e-8

  # 优化器
  optimizer: "adamw"
  weight_decay: 0.1
  beta1: 0.9
  beta2: 0.999


  # 混合精度
  use_amp: true                          # 启用AMP

  # 梯度裁剪
  clip_grad_norm: 0.5

  # 日志和保存
  log_interval: 50
  val_interval: 5
  save_interval: 50

  # ema配置
  use_ema: true
  ema_decay: 0.999

# ===== 模型配置 =====
model:
  # ===== 基础配置 =====
  image_size: 12                        # Abilene数据集是12×12
  history_len: 16

  # ===== 视觉编码器配置 =====
  vision_encoder_type: "Improved_cnn"

  # ImprovedCNN配置
  cnn_channels: [32, 64, 128, 256]
  cnn_num_blocks: 4
  cnn_use_residual: true
  cnn_use_attention: true
  cnn_pool_type: "dual"
  visual_dim: 512

  # 时序聚合器配置
  num_temporal_layers: 4
  num_output_tokens: 64
  temporal_aggregation_method: "enhanced"
  temporal_use_causal_mask: true
  temporal_use_time_embed: true

  # 如果使用 CLIP（可选，注释掉如果用 simple_cnn）
  # vision_encoder_name: "openai/clip-vit-base-patch16"
  # freeze_vision_encoder: true

  # ===== Qwen配置 =====
  qwen_model_name: "D:/PyCharm/traffic_prediction_trial/LLMDiff/model_downloaded/Qwen/Qwen2-0___5B"

  # ===== Adapter配置 =====
  adapter_dim: 256
  adapter_size: 128
  adapter_layers: "all"
  adapter_dropout: 0.25
  adapter_use_conv: false
  adapter_use_gate: false
  adapter_activation: "gelu"
  adapter_use_zero_init: true
  adapter_use_attention: false
  adapter_conv_kernels: [ 3, 5 ]
  adapter_use_layernorm: true
  adapter_gradient_checkpointing: false

  # ===== 多尺度条件配置 =====
  use_multiscale_condition: false

  # 多尺度维度配置
  global_condition_dim: 512
  local_condition_dim: 512
  temporal_condition_dim: 256

  condition_type: "multiscale"
  condition_dim: 512
  condition_fusion_layers: 2
  condition_cross_enhance: false


  # ===== UNet配置 =====
  unet_base_channels: 128
  unet_channel_mult: [1, 2, 4]
  unet_num_res_blocks: 2
  unet_attention_resolutions: [3]

  # ===== Diffusion配置 =====
  use_full_training: true     # 使用完整扩散训练
  ddpm_train_steps: 10        # 训练时的采样步数（20-100）
  ddpm_val_steps: 50          # 验证时的采样步数
  num_diffusion_steps: 1000              # 训练步数
  num_inference_steps: 50                # 推理步数
  beta_schedule: "squaredcos_cap_v2"                # 或 "scaled_linear"

  # ===== 其他配置 =====
  dropout: 0.2
  freeze_vision_encoder: false
  use_cfg: true
  cfg_dropout_prob: 0.15
  cfg_scale: 2.0
  prediction_type: 'v_prediction'
  use_film: true

  # 加权MSE配置
  use_weighted_mse: true
  low_traffic_threshold: 0.2
  mid_traffic_threshold: 0.5
  low_traffic_weight: 2.0
  mid_traffic_weight: 1.5
  high_traffic_weight: 2.0

  # 多尺度损失配置
  use_multiscale_loss: true
  multiscale_scales: [ 1, 2]
  multiscale_weights: [ 1.0, 0.15]

  # 梯度损失配置
  use_gradient_loss: true
  gradient_loss_weight: 0.03

  # 感知损失
  use_perceptual_loss: true
  perceptual_loss_weight: 0.01
  perceptual_feature_layers: [ 2, 3 ]

# ===== 硬件配置 =====
hardware:
  device: "cuda"
  num_workers: 4
  pin_memory: true
  persistent_workers: true

# ===== 路径配置 =====
paths:
  output_dir: "./outputs/abilene_4060_localtest_enhancedcnn_1119_5_0.3-0.7"
  checkpoint_dir: "./outputs/abilene_4060_localtest_enhancedcnn/checkpoints_4060_enhancedcnn_1119_5_0.3-0.7"
  log_dir: "./outputs/abilene_4060_localtest_enhancedcnn/logs_4060_enhancedcnn_1119_5_0.3-0.7"
  result_dir: "./outputs/abilene_4060_localtest_enhancedcnn/results_4060_enhancedcnn_1119_5_0.3-0.7"
  vis_dir: "./outputs/abilene_4060_localtest_enhancedcnn/visualizations_4060_enhancedcnn_1119_5_0.3-0.7"

# ===== 实验追踪 =====
logging:
  use_wandb: false
  wandb_project: "traffic-diffusion"
  log_gradients: false
  log_images_interval: 10

# ===== ✅ 新增：早停配置 =====
early_stopping:
  enabled: true
  patience: 30
  min_delta: 0.001
  metric: "val_loss"
  mode: "min"